# App Store Connect Webhook è½¬å‘å™¨ (è‡³é£ä¹¦ / Lark)

è¿™æ˜¯ä¸€ä¸ªåŸºäº Google Cloud Functions çš„æ— æœåŠ¡å™¨ï¼ˆServerlessï¼‰åº”ç”¨ï¼Œ
ç”¨äºæ¥æ”¶æ¥è‡ª App Store Connect çš„ Webhook é€šçŸ¥ï¼Œ
å¹¶å°†å…¶æ ¼å¼åŒ–ä¸ºå†…å®¹ä¸°å¯Œçš„å¡ç‰‡æ¶ˆæ¯ï¼Œå®‰å…¨åœ°è½¬å‘åˆ°æŒ‡å®šçš„é£ä¹¦ (Feishu) æˆ– Lark ç¾¤ç»„ä¸­ã€‚

å½“æ‚¨çš„ App åœ¨ App Store Connect ä¸­çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼ˆä¾‹å¦‚ï¼šç‰ˆæœ¬çŠ¶æ€æ›´æ–°ã€æ”¶åˆ°æ–°çš„ TestFlight åé¦ˆç­‰ï¼‰ï¼Œ
æ‚¨å’Œæ‚¨çš„å›¢é˜Ÿå¯ä»¥åœ¨é£ä¹¦æˆ– Lark ä¸­ç«‹å³æ”¶åˆ°é€šçŸ¥ã€‚

## âœ¨ ä¸»è¦ç‰¹æ€§

* **ğŸš€ æ— æœåŠ¡å™¨æ¶æ„**: åŸºäº Google Cloud Functions éƒ¨ç½²ï¼Œæ— éœ€è´­ä¹°å’Œç»´æŠ¤æœåŠ¡å™¨ï¼Œæˆæœ¬æä½ï¼Œå…·å¤‡é«˜å¯ç”¨æ€§å’Œè‡ªåŠ¨æ‰©ç¼©å®¹èƒ½åŠ›ã€‚
* **ğŸ” åŒå‘å®‰å…¨éªŒè¯**:
    * éªŒè¯æ¥è‡ª App Store Connect çš„è¯·æ±‚ç­¾åï¼Œç¡®ä¿æ¶ˆæ¯æ¥æºå¯ä¿¡ã€‚
    * å‘é£ä¹¦ / Lark å‘é€æ¶ˆæ¯æ—¶è¿›è¡Œç­¾åï¼Œé˜²æ­¢ Webhook URL è¢«æ»¥ç”¨ã€‚
* **ğŸ¨ ä¸°å¯Œçš„æ¶ˆæ¯æ ¼å¼**: å°†ä¸åŒç±»å‹çš„é€šçŸ¥ï¼ˆå¦‚ç‰ˆæœ¬çŠ¶æ€ã€æ„å»ºçŠ¶æ€ã€TestFlight åé¦ˆï¼‰è§£æå¹¶æ ¼å¼åŒ–ä¸ºç¾è§‚ä¸”æ˜“äºé˜…è¯»çš„å¡ç‰‡æ¶ˆæ¯ã€‚
* **ğŸ“± æ”¯æŒå¤šåº”ç”¨**: å•ä¸ªäº‘å‡½æ•°å®ä¾‹å¯ä»¥æ¥æ”¶å¹¶å¤„ç†æ¥è‡ªæ‚¨è´¦æˆ·ä¸‹å¤šä¸ªä¸åŒ App çš„é€šçŸ¥ï¼Œå¹¶åœ¨æ¶ˆæ¯ä¸­è‡ªåŠ¨åŒºåˆ†ã€‚
* **ğŸ æ˜“äºéƒ¨ç½²ä¸å®šåˆ¶**: ä½¿ç”¨ Python ç¼–å†™ï¼Œä»£ç é€»è¾‘æ¸…æ™°ï¼Œä»…éœ€ä¸€æ¡ gcloud å‘½ä»¤å³å¯å®Œæˆéƒ¨ç½²ï¼Œå¹¶å¯è½»æ¾è‡ªå®šä¹‰æ¶ˆæ¯å¡ç‰‡æ ·å¼ã€‚
* **ğŸ”„ æŒç»­é›†æˆ/æŒç»­éƒ¨ç½²**: æ”¯æŒé€šè¿‡ GitHub Actions å®ç°è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œpush ä»£ç å³å¯è‡ªåŠ¨æ›´æ–°äº‘å‡½æ•°ã€‚

## ğŸ› ï¸ éƒ¨ç½²æŒ‡å—

ä»¥ä¸‹ä¸ºæ‰‹åŠ¨éƒ¨ç½²çš„æ­¥éª¤ã€‚å¦‚æœæ‚¨å¸Œæœ›é…ç½®è‡ªåŠ¨åŒ–éƒ¨ç½²ï¼Œè¯·å‚è€ƒä¸‹ä¸€ç« èŠ‚ã€‚

### ç¬¬ 1 æ­¥ï¼šåœ¨é£ä¹¦ / Lark ä¸­åˆ›å»ºæœºå™¨äºº

1. åœ¨é£ä¹¦æˆ– Lark ä¸­é€‰æ‹©ä¸€ä¸ªæ‚¨æƒ³æ¥æ”¶é€šçŸ¥çš„ç¾¤ç»„ã€‚
2. è¿›å…¥ç¾¤ç»„ **è®¾ç½® -> ç¾¤æœºå™¨äºº -> æ·»åŠ æœºå™¨äºº**ã€‚
3. é€‰æ‹© **â€œè‡ªå®šä¹‰æœºå™¨äººâ€**ã€‚
4. ä¸ºæœºå™¨äººè®¾ç½®ä¸€ä¸ªåç§°ï¼ˆä¾‹å¦‚ï¼šâ€œApp Store é€šçŸ¥â€ï¼‰å’Œæè¿°ã€‚
5. ï¼ˆå¯é€‰ï¼‰åœ¨â€œå®‰å…¨è®¾ç½®â€ä¸­ï¼Œé€‰æ‹© **â€œç­¾åæ ¡éªŒâ€**ã€‚
6. ç‚¹å‡»â€œæ·»åŠ â€åï¼Œæ‚¨ä¼šå¾—åˆ°ä¸¤ä¸ªå…³é”®ä¿¡æ¯ï¼Œè¯·åŠ¡å¿…å¤åˆ¶å¹¶ä¿å­˜å¥½ï¼š
    * **Webhook åœ°å€**
    * ï¼ˆå¯é€‰ï¼‰**ç­¾åå¯†é’¥ (Signing Key)**

### ç¬¬ 2 æ­¥ï¼šéƒ¨ç½²äº‘å‡½æ•°

**å‰ææ¡ä»¶:**

* æ‹¥æœ‰ä¸€ä¸ª Google Cloud Platform (GCP) è´¦å·ï¼Œå¹¶å·²åˆ›å»ºå¥½é¡¹ç›®ã€‚
* åœ¨æœ¬åœ°å®‰è£…å¹¶é…ç½®å¥½äº† gcloud å‘½ä»¤è¡Œå·¥å…·ã€‚
* å·²ä¸ºæ‚¨çš„ GCP é¡¹ç›®[å¼€é€š Cloud Functions API](https://console.cloud.google.com/apis/library/cloudfunctions.googleapis.com)ã€‚

**éƒ¨ç½²æ“ä½œ:**

1. å°† main.py å’Œ requirements.txt æ–‡ä»¶ä¿å­˜åœ¨æœ¬åœ°åŒä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­ã€‚
2. æ‰“å¼€ç»ˆç«¯ï¼Œè¿›å…¥è¯¥æ–‡ä»¶å¤¹ã€‚
3. æ‰§è¡Œä»¥ä¸‹éƒ¨ç½²å‘½ä»¤ï¼š

```
gcloud functions deploy app-store-webhook-forwarder \
--runtime python39 \
--trigger-http \
--allow-unauthenticated \
--entry-point webhook_handler \
--set-env-vars LARK_WEBHOOK_URL="æ‚¨è·å–çš„Webhookåœ°å€",LARK_SIGNING_SECRET="æ‚¨è·å–çš„æœºå™¨äººç­¾åå¯†é’¥",APP_STORE_CONNECT_SECRET="æ‚¨è®¾å®šçš„ä¸€ä¸ªéšæœºå¯†é’¥"
```

**è¯·åŠ¡å¿…æ›¿æ¢å‘½ä»¤ä¸­çš„ä¸‰ä¸ªå‚æ•°**ï¼š

* LARK_WEBHOOK_URL: æ›¿æ¢ä¸ºç¬¬ 1 æ­¥ä¸­è·å–çš„ **Webhook åœ°å€**ã€‚
* LARK_SIGNING_SECRET: ï¼ˆå¯é€‰ï¼‰æ›¿æ¢ä¸ºç¬¬ 1 æ­¥ä¸­è·å–çš„ **ç­¾åå¯†é’¥**ã€‚
* APP_STORE_CONNECT_SECRET: **åˆ›å»ºä¸€ä¸ªæ‚¨è‡ªå·±çš„ã€è¶³å¤Ÿå¤æ‚çš„éšæœºå­—ç¬¦ä¸²**ä½œä¸ºå¯†é’¥ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡ openssl rand -hex 32 ç”Ÿæˆï¼‰ã€‚
  è¿™ä¸ªå¯†é’¥å°†ç”¨äº App Store Connect å’Œäº‘å‡½æ•°ä¹‹é—´çš„é€šä¿¡ã€‚

éƒ¨ç½²æˆåŠŸåï¼ŒGCP ä¼šè¿”å›ä¸€ä¸ª **HTTPS è§¦å‘å™¨ URL**ã€‚è¯·å¤åˆ¶å¹¶ä¿å­˜è¿™ä¸ª URLã€‚

### ç¬¬ 3 æ­¥ï¼šåœ¨ App Store Connect ä¸­é…ç½® Webhook

1. ç™»å½• [App Store Connect](https://appstoreconnect.apple.com/)ã€‚
2. å¯¼èˆªè‡³ **ç”¨æˆ·å’Œè®¿é—® -> é›†æˆ** æ ‡ç­¾é¡µã€‚
3. åœ¨å·¦ä¾§è¾¹æ é€‰æ‹© **Webhooks**ï¼Œç„¶åç‚¹å‡» **â€œ+â€** æ·»åŠ ã€‚
4. å¡«å†™é…ç½®ä¿¡æ¯ï¼š
    * **åç§° (Name)**: å¡«å†™ä¸€ä¸ªæ–¹ä¾¿è¯†åˆ«çš„åç§°ï¼ˆä¾‹å¦‚ï¼šâ€œNotifierâ€ï¼‰ã€‚
    * **URL**: ç²˜è´´æ‚¨åœ¨ç¬¬ 2 æ­¥ä¸­éƒ¨ç½²äº‘å‡½æ•°åå¾—åˆ°çš„ **HTTPS è§¦å‘å™¨ URL**ã€‚
    * **å¯†é’¥ (Secret)**: ç²˜è´´æ‚¨åœ¨ç¬¬ 2 æ­¥ä¸­ä¸º APP_STORE_CONNECT_SECRET è®¾å®šçš„é‚£ä¸ª**éšæœºå¯†é’¥**ã€‚
    * **äº‹ä»¶ (Events)**: é€‰æ‹©æ‚¨å¸Œæœ›ç›‘å¬çš„æ‰€æœ‰äº‹ä»¶ç±»å‹ã€‚
5. ç‚¹å‡»â€œåˆ›å»ºâ€ã€‚App Store Connect ä¼šç«‹å³å‘é€ä¸€ä¸ªæµ‹è¯•è¯·æ±‚ï¼Œæ‚¨å¯ä»¥åœ¨ç¾¤ç»„ä¸­æŸ¥çœ‹æ˜¯å¦æ”¶åˆ°äº†æµ‹è¯•é€šçŸ¥ã€‚

## ğŸš€ (å¯é€‰) è‡ªåŠ¨åŒ–éƒ¨ç½² (CI/CD)

æ‚¨å¯ä»¥é…ç½® GitHub Actionsï¼Œå®ç°åœ¨ä»£ç æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨éƒ¨ç½²æˆ–æ›´æ–°æ‚¨çš„ Google Cloud Functionã€‚

### ç¬¬ 1 æ­¥ï¼šè·å– GCP æœåŠ¡è´¦å·å¯†é’¥

ä¸ºäº†è®© GitHub Actions æœ‰æƒé™æ“ä½œæ‚¨çš„ GCP èµ„æºï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªæœåŠ¡è´¦å·å¹¶è·å–å…¶ JSON å¯†é’¥ã€‚

* **è¯·å‚è€ƒ [å¦‚ä½•è·å– GCP æœåŠ¡è´¦å·å¯†é’¥](https://www.google.com/search?q=gcp_service_account_key_guide.md) è¿™ä»½è¯¦ç»†æŒ‡å—å®Œæˆæ“ä½œã€‚**

### ç¬¬ 2 æ­¥ï¼šåœ¨ GitHub ä»“åº“ä¸­é…ç½® Secrets

å°†æ‚¨çš„å¯†é’¥å’Œé…ç½®ä¿¡æ¯å®‰å…¨åœ°å­˜å‚¨åœ¨ GitHub çš„ Secrets ä¸­ã€‚

1. æ‰“å¼€æ‚¨çš„ GitHub ä»“åº“é¡µé¢ï¼Œè¿›å…¥ **Settings** > **Secrets and variables** > **Actions**ã€‚
2. ç‚¹å‡» **â€œNew repository secretâ€** æŒ‰é’®ï¼Œä¾æ¬¡æ·»åŠ ä»¥ä¸‹å››ä¸ª Secretsï¼š
    * GCP_SA_KEY: å°†æ‚¨åœ¨ä¸Šä¸€æ­¥è·å–çš„ **.json å¯†é’¥æ–‡ä»¶çš„å…¨éƒ¨å†…å®¹**ç²˜è´´åˆ°è¿™é‡Œã€‚
    * LARK_WEBHOOK_URL: æ‚¨çš„é£ä¹¦ / Lark æœºå™¨äºº Webhook åœ°å€ã€‚
    * LARK_SIGNING_SECRET: ï¼ˆå¯é€‰ï¼‰æ‚¨çš„é£ä¹¦ / Lark æœºå™¨äººç­¾åå¯†é’¥ã€‚
    * APP_STORE_CONNECT_SECRET: æ‚¨ä¸º App Store Connect Webhook è®¾å®šçš„å…±äº«å¯†é’¥ã€‚

### ç¬¬ 3 æ­¥ï¼šåˆ›å»º GitHub Action å·¥ä½œæµ

1. åœ¨æ‚¨çš„é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œåˆ›å»ºä¸€ä¸ª .github/workflows æ–‡ä»¶å¤¹ã€‚
2. åœ¨è¯¥æ–‡ä»¶å¤¹ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªåä¸º deploy.yml çš„æ–‡ä»¶ã€‚
3. å°†ä»¥ä¸‹å†…å®¹ç²˜è´´åˆ° deploy.yml æ–‡ä»¶ä¸­ï¼š

```yaml
name: Deploy to Google Cloud Functions

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}' # åœ¨ GitHub secrets ä¸­é…ç½® GCP æœåŠ¡è´¦å·å¯†é’¥

      - name: Deploy Function
        uses: 'google-github-actions/deploy-cloud-functions@v1'
        with:
          name: app-store-webhook-forwarder # å‡½æ•°åç§°
          runtime: python312
          entry_point: webhook_handler
          env_vars: |
            LARK_WEBHOOK_URL=${{ secrets.LARK_WEBHOOK_URL }}
            LARK_SIGNING_SECRET=${{ secrets.LARK_SIGNING_SECRET }}
            APP_STORE_CONNECT_SECRET=${{ secrets.APP_STORE_CONNECT_SECRET }}
```

é…ç½®å®Œæˆåï¼Œæ¯å½“æ‚¨å‘ main åˆ†æ”¯æ¨é€ä»£ç æ—¶ï¼Œ
GitHub Actions å°±ä¼šè‡ªåŠ¨å°†æœ€æ–°çš„ä»£ç éƒ¨ç½²åˆ°æ‚¨çš„
Google Cloud Functionï¼Œæ— éœ€ä»»ä½•æ‰‹åŠ¨æ“ä½œã€‚

## âš™ï¸ ç¯å¢ƒå˜é‡

æœ¬å‡½æ•°é€šè¿‡ç¯å¢ƒå˜é‡è¿›è¡Œé…ç½®ï¼Œä»¥ç¡®ä¿å¯†é’¥ç­‰æ•æ„Ÿä¿¡æ¯çš„å®‰å…¨ã€‚

| ç¯å¢ƒå˜é‡                     | ä½œç”¨                           | æ˜¯å¦å¿…é¡» |
|--------------------------|------------------------------|------|
| LARK_WEBHOOK_URL         | é£ä¹¦ / Lark è‡ªå®šä¹‰æœºå™¨Webhook åœ°å€ã€‚   | æ˜¯    |
| LARK_SIGNING_SECRET      | ç”¨äºå¯¹å‘é€åˆ°é£ä¹¦ / Lark çš„æ¶ˆæ¯è¿›è¡Œç­¾åã€‚     | å¦    |
| APP_STORE_CONNECT_SECRET | ç”¨äºéªŒè¯ App Store Connect è¯·æ±‚ç­¾åã€‚ | æ˜¯    |

## ğŸ¨ è‡ªå®šä¹‰

å¦‚æœæ‚¨æƒ³ä¿®æ”¹é£ä¹¦ / Lark å¡ç‰‡æ¶ˆæ¯çš„æ ·å¼æˆ–å†…å®¹ï¼Œ
å¯ä»¥ç›´æ¥ç¼–è¾‘ main.py æ–‡ä»¶ä¸­çš„ format_lark_card å‡½æ•°ã€‚
æ‚¨å¯ä»¥æ ¹æ® App Store Connect å‘é€çš„ JSON æ•°æ®ï¼Œè‡ªç”±åœ°å¢åˆ å­—æ®µæˆ–è°ƒæ•´å¡ç‰‡å¸ƒå±€ã€‚

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ [MIT License](https://opensource.org/licenses/MIT) æˆæƒã€‚
