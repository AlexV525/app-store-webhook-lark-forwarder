name: Deploy to Google Cloud Functions

on:
  push:
    branches:
      - main # å½“ main åˆ†æ”¯æœ‰æ›´æ–°æ—¶è§¦å‘
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘æ„å»º

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # å¿…é¡»æ·»åŠ æ­¤æƒé™ï¼Œç”¨äº OIDC è®¤è¯

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: pip install requests

    - name: Authenticate to Google Cloud
      id: auth
      uses: 'google-github-actions/auth@v2'
      with:
        project_id: '${{ secrets.GCP_PROJECT_ID }}'
        workload_identity_provider: '${{ secrets.WIF_PROVIDER }}'
        service_account: '${{ secrets.GCP_SA_EMAIL }}'

    - name: Deploy Function
      id: 'deploy'
      uses: 'google-github-actions/deploy-cloud-functions@v4'
      timeout-minutes: 10
      with:
        project_id: '${{ secrets.GCP_PROJECT_ID }}'
        name: 'app-store-webhook-forwarder'
        region: 'us-central1' # æ‚¨å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹åŒºåŸŸ
        runtime: 'python312' # æ‚¨å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ Python ç‰ˆæœ¬
        entry_point: 'webhook_handler'
        environment: 'GEN_2'
        environment_variables: |-
          LARK_WEBHOOK_URL=${{ secrets.LARK_WEBHOOK_URL }}
          LARK_SIGNING_SECRET=${{ secrets.LARK_SIGNING_SECRET }}
          APP_STORE_CONNECT_SECRET=${{ secrets.APP_STORE_CONNECT_SECRET }}

    - name: Send Private Notification to Lark
      if: success() && steps.deploy.outputs.url
      env:
        LARK_WEBHOOK_URL: ${{ secrets.LARK_WEBHOOK_URL }}
        LARK_SIGNING_SECRET: ${{ secrets.LARK_SIGNING_SECRET }}
      run: |
        python main.py \
          --title "ğŸš€ éƒ¨ç½²æˆåŠŸé€šçŸ¥" \
          --content "App Store Webhook å‡½æ•°å·²æˆåŠŸéƒ¨ç½²ã€‚**æœ€æ–° URL:** ${{ steps.deploy.outputs.url }}"
